<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Tracker</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📚</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0a0f1a;
            --card: #0b1220;
            --text: #e6eef8;
            --muted: #94a3b8;
            --accent: #60a5fa;
            --good: #34d399;
            --danger: #fb7185;
            --glass: rgba(255,255,255,0.03);
            --shadow: 0 8px 24px rgba(0,0,0,0.5);
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }

        [data-theme="light"] {
            --bg: #f0f4f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --accent: #3b82f6;
            --good: #10b981;
            --danger: #ef4444;
            --glass: rgba(0,0,0,0.03);
            --shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 28px auto;
            padding: 18px;
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            position: relative;
        }

        h1 {
            font-size: 20px;
            margin: 0;
        }

        .theme-toggle {
            margin-left: auto;
            background: var(--card);
            border: 1px solid var(--glass);
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text);
        }

        .theme-toggle:hover {
            background: var(--accent);
            color: white;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 18px;
            margin-top: 18px;
        }

        @media (max-width: 980px) {
            .content {
                grid-template-columns: 1fr;
            }
            .right-col {
                order: 2;
            }
        }

        .card {
            background: var(--card);
            padding: 18px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass);
        }

        .subject-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .subject {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--glass);
            border-radius: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .subject:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .subject h3 {
            margin: 0;
            font-size: 16px;
        }

        .subject .meta {
            margin-left: auto;
            text-align: right;
        }

        .small {
            font-size: 12px;
            color: var(--muted);
        }

        label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        input[type=number] {
            width: 90px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--glass);
            background: var(--card);
            color: var(--text);
        }

        select, button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            background: var(--accent);
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        select {
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--glass);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .progress-wrap {
            width: 210px;
            height: 12px;
            background: var(--glass);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #7dd3fc);
            width: 0%;
            border-radius: 10px;
        }

        .timer {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .time-display {
            font-size: 28px;
            font-weight: 600;
        }

        .stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stat {
            flex: 1;
            min-width: 160px;
            padding: 12px;
            border-radius: 8px;
            background: var(--glass);
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--glass);
        }

        .small-note {
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
        }

        .pomodoro {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 18px;
        }

        .pomodoro-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        .pomodoro-display {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin: 10px 0;
            font-family: monospace;
        }

        .pomodoro-mode {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .pomodoro-mode button {
            padding: 6px 12px;
            font-size: 14px;
        }

        .pomodoro-mode button.active {
            background: var(--good);
        }
        
        .pomo-session-count {
            text-align: center;
            font-size: 14px;
            color: var(--muted);
            margin-top: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div style="width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#7dd3fc);display:flex;align-items:center;justify-content:center;color:#04263b;font-weight:700">ST</div>
        <div>
            <h1>Study To-Do & Timer</h1>
            <div class="small">8 subjects, chapters tracker, timer with daily/weekly/monthly aggregation & graph</div>
        </div>
        <button class="theme-toggle" id="themeToggle">
            <span id="themeIcon">🌙</span> <span id="themeText">Dark Mode</span>
        </button>
    </header>

    <div class="content">
        <div class="left-col">
            <div class="card" id="todoPane">
                <h2 style="margin-top:0">Your Subjects</h2>
                <div class="subject-list" id="subjectList">
                    <!-- subjects injected by JS -->
                </div>
                <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
                    <button id="resetSubjects">Reset Subjects</button>
                    <div class="small-note">Reset will clear saved counts and timer sessions.</div>
                </div>
            </div>

            <div class="card" style="margin-top:12px">
                <h3 style="margin:0 0 8px 0">All Subjects Progress</h3>
                <table>
                    <thead><tr><th>Subject</th><th>Chapters</th><th>Completed</th><th>%</th></tr></thead>
                    <tbody id="summaryTable"></tbody>
                </table>
            </div>
        </div>

        <div class="right-col">
            <div class="card timer" id="timerPane">
                <h3 style="margin:0">Timer & Recording</h3>
                <div style="margin-top:8px">
                    <label for="subjectSelect">Select Subject</label>
                    <select id="subjectSelect"></select>
                </div>

                <div style="display:flex;align-items:center;gap:12px;margin-top:12px">
                    <div class="time-display" id="timeDisplay">00:00:00</div>
                    <div style="margin-left:auto;display:flex;gap:8px">
                        <button id="startBtn">Start</button>
                        <button id="pauseBtn" disabled>Pause</button>
                        <button id="saveBtn" disabled>Stop & Save</button>
                    </div>
                </div>

                <div class="controls">
                    <button id="resetTimer">Reset Timer</button>
                    <label style="margin-left:auto">View: <select id="periodSelect"><option value="week">This Week</option><option value="month">This Month</option></select></label>
                </div>

                <div class="stats" style="margin-top:10px">
                    <div class="stat"><div class="small">Today</div><div id="todayTime">0h 0m</div></div>
                    <div class="stat"><div class="small">Weekly</div><div id="weeklyTime">0h 0m</div></div>
                    <div class="stat"><div class="small">Monthly</div><div id="monthlyTime">0h 0m</div></div>
                    <div class="stat"><div class="small">Total Sessions</div><div id="sessionsCount">0</div></div>
                </div>
            </div>

            <div class="card" style="margin-top:12px">
                <h3 style="margin:0">Study Time Graph</h3>
                <div style="height:260px;margin-top:10px"><canvas id="timeChart"></canvas></div>
                <div class="small-note">Bar graph shows time (hours) per subject for the selected period.</div>
            </div>

            <div class="card pomodoro" style="margin-top:12px">
                <h3 style="margin:0">Pomodoro Mode</h3>
                <div class="pomodoro-mode">
                    <button id="pomoWork" class="active">Work (25m)</button>
                    <button id="pomoShort">Short Break (5m)</button>
                    <button id="pomoLong">Long Break (15m)</button>
                </div>
                <div class="pomodoro-display" id="pomoDisplay">25:00</div>
                <div class="pomodoro-controls">
                    <button id="pomoStart">Start</button>
                    <button id="pomoPause" disabled>Pause</button>
                    <button id="pomoReset">Reset</button>
                </div>
                <div class="pomo-session-count">Sessions completed: <span id="pomoSessions">0</span></div>
                <div class="small-note">Focus for 25 minutes, then take a 5-minute break</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Data model & defaults ---
    const DEFAULT_SUBJECTS = [
        'Accounting','Income Tax','GST','Law','Costing','Financial Management','Strategic Management','Auditing'
    ];

    const LS_SUBJECTS = 'study_subjects_v1';
    const LS_SESSIONS = 'study_sessions_v1';
    const LS_POMODORO = 'study_pomodoro_v1';

    // Theme management
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');
    
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeButton(savedTheme);
    }
    
    function updateThemeButton(theme) {
        if (theme === 'light') {
            themeIcon.textContent = '☀️';
            themeText.textContent = 'Light Mode';
        } else {
            themeIcon.textContent = '🌙';
            themeText.textContent = 'Dark Mode';
        }
    }
    
    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeButton(newTheme);
    });

    // load or init
    function loadSubjects(){
        const raw = localStorage.getItem(LS_SUBJECTS);
        if(raw) return JSON.parse(raw);
        const init = DEFAULT_SUBJECTS.map(name=>({name, chapters:0, completed:0}));
        localStorage.setItem(LS_SUBJECTS, JSON.stringify(init));
        return init;
    }
    function saveSubjects(arr){ localStorage.setItem(LS_SUBJECTS, JSON.stringify(arr)); }

    function loadSessions(){
        const raw = localStorage.getItem(LS_SESSIONS);
        if(raw) return JSON.parse(raw);
        return [];
    }
    function saveSessions(arr){ localStorage.setItem(LS_SESSIONS, JSON.stringify(arr)); }

    function loadPomodoro(){
        const raw = localStorage.getItem(LS_POMODORO);
        if(raw) return JSON.parse(raw);
        return { sessions: 0 };
    }
    function savePomodoro(obj){ localStorage.setItem(LS_POMODORO, JSON.stringify(obj)); }

    let subjects = loadSubjects();
    let sessions = loadSessions();
    let pomodoro = loadPomodoro();

    // --- UI helpers ---
    const subjectList = document.getElementById('subjectList');
    const subjectSelect = document.getElementById('subjectSelect');
    const summaryTable = document.getElementById('summaryTable');

    function renderSubjects(){
        subjectList.innerHTML=''; subjectSelect.innerHTML='';
        subjects.forEach((s,idx)=>{
            const div = document.createElement('div'); div.className='subject';
            div.innerHTML = `
                <div style="width:42px;height:42px;border-radius:8px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:700">${s.name.split(' ').map(p=>p[0]).slice(0,2).join('')}</div>
                <div style="min-width:160px">
                    <h3>${s.name}</h3>
                    <div class="small">Chapters: <input type="number" min="0" value="${s.chapters}" data-idx="${idx}" class="chap-input" style="width:84px"> &nbsp; Completed: <input type="number" min="0" value="${s.completed}" data-idx="${idx}" class="comp-input" style="width:84px"> <button data-idx="${idx}" class="saveSubject">Save</button></div>
                </div>
                <div class="meta">
                    <div class="small">% Completed</div>
                    <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
                        <div class="progress-wrap"><div class="progress-bar" id="pb${idx}" style="width:${computePercent(s)}%"></div></div>
                        <div style="min-width:40px;text-align:right;font-weight:600">${computePercent(s)}%</div>
                    </div>
                </div>
            `;
            subjectList.appendChild(div);

            const opt = document.createElement('option'); opt.value = idx; opt.textContent = s.name; subjectSelect.appendChild(opt);
        });
        renderSummaryTable();
        attachSubjectHandlers();
    }

    function computePercent(s){
        if(!s.chapters || s.chapters==0) return 0;
        const p = Math.round((s.completed / s.chapters) * 100);
        return Math.min(100, Math.max(0,p));
    }

    function renderSummaryTable(){
        summaryTable.innerHTML='';
        subjects.forEach((s,idx)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.name}</td><td>${s.chapters}</td><td>${s.completed}</td><td>${computePercent(s)}%</td>`;
            summaryTable.appendChild(tr);
        });
    }

    function attachSubjectHandlers(){
        document.querySelectorAll('.saveSubject').forEach(btn=>{
            btn.onclick = ()=>{
                const idx = +btn.dataset.idx;
                const chap = Math.max(0, parseInt(document.querySelector(`.chap-input[data-idx='${idx}']`).value) || 0);
                const comp = Math.max(0, parseInt(document.querySelector(`.comp-input[data-idx='${idx}']`).value) || 0);
                subjects[idx].chapters=chap; subjects[idx].completed=Math.min(comp,chap);
                saveSubjects(subjects);
                renderSubjects();
            }
        })
    }

    document.getElementById('resetSubjects').onclick = ()=>{
        if(!confirm('Reset all chapters and sessions?')) return;
        subjects = DEFAULT_SUBJECTS.map(name=>({name,chapters:0,completed:0})); saveSubjects(subjects);
        sessions = []; saveSessions(sessions);
        renderSubjects(); updateStatsAndChart();
    }

    // --- Timer logic (background-safe) ---
    let timerInterval = null;
    let startTime = null;
    let elapsedBefore = 0; // seconds accumulated before current run
    let running = false;

    const timeDisplay = document.getElementById('timeDisplay');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const saveBtn = document.getElementById('saveBtn');
    const resetTimerBtn = document.getElementById('resetTimer');
    const periodSelect = document.getElementById('periodSelect');

    function formatHMS(sec){
        const h = Math.floor(sec/3600);
        const m = Math.floor((sec%3600)/60);
        const s = sec%60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function updateDisplay(){
        let totalElapsed = elapsedBefore;
        if(running){
            totalElapsed += Math.floor((Date.now() - startTime)/1000);
        }
        timeDisplay.textContent = formatHMS(totalElapsed);
    }

    startBtn.onclick = ()=>{
        if(running) return;
        running = true;
        startBtn.disabled = true;
        pauseBtn.disabled = false;
        saveBtn.disabled = false;
        startTime = Date.now();
        timerInterval = setInterval(updateDisplay, 500); // update twice per second
    }

    pauseBtn.onclick = ()=>{
        if(!running) return;
        running = false;
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        elapsedBefore += Math.floor((Date.now() - startTime)/1000);
        clearInterval(timerInterval);
    }

    resetTimerBtn.onclick = ()=>{
        if(confirm('Reset current timer?')){
            running = false;
            clearInterval(timerInterval);
            elapsedBefore = 0;
            startTime = null;
            timeDisplay.textContent='00:00:00';
            startBtn.disabled=false;
            pauseBtn.disabled=true;
            saveBtn.disabled=true;
        }
    }

    saveBtn.onclick = ()=>{
        let totalElapsed = elapsedBefore;
        if(running){
            totalElapsed += Math.floor((Date.now() - startTime)/1000);
        }
        if(totalElapsed <= 0){ alert('No time recorded. Start timer first.'); return; }

        const subjIdx = +subjectSelect.value;
        const session = {subject: subjIdx, seconds: totalElapsed, ts: new Date().toISOString()};
        sessions.push(session); saveSessions(sessions);

        // reset timer
        running=false; clearInterval(timerInterval); elapsedBefore=0; startTime=null; timeDisplay.textContent='00:00:00';
        startBtn.disabled=false; pauseBtn.disabled=true; saveBtn.disabled=true;
        updateStatsAndChart();
        document.getElementById('sessionsCount').textContent = sessions.length;
    }

    // --- Aggregation and charting ---
    const todayEl = document.getElementById('todayTime');
    const weeklyEl = document.getElementById('weeklyTime');
    const monthlyEl = document.getElementById('monthlyTime');
    const sessionsCountEl = document.getElementById('sessionsCount');

    function secondsToHM(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); return `${h}h ${m}m`; }

    function startOfDay(dt){ const d=new Date(dt); d.setHours(0,0,0,0); return d; }
    function startOfWeek(dt){ const d=new Date(dt); const day = (d.getDay()+6)%7; d.setHours(0,0,0,0); d.setDate(d.getDate()-day); return d; }
    function startOfMonth(dt){ const d=new Date(dt); d.setDate(1); d.setHours(0,0,0,0); return d; }

    function aggregate(period='week'){
        const now = new Date();
        let start;
        if(period==='day') start = startOfDay(now);
        else if(period==='week') start = startOfWeek(now);
        else start = startOfMonth(now);

        const totals = Array(subjects.length).fill(0);
        let tot=0;
        sessions.forEach(s=>{
            const ts = new Date(s.ts);
            if(ts>=start && ts<=now){ totals[Number(s.subject)]+=s.seconds; tot+=s.seconds; }
        });
        return {totals, tot};
    }

    let chart=null;
    function createChart(labels, data){
        const ctx = document.getElementById('timeChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type:'bar', data:{labels, datasets:[{label:'Hours studied', data: data.map(s=>Number((s/3600).toFixed(2))), backgroundColor: '#60a5fa' }]},
            options:{scales:{y:{beginAtZero:true}}, plugins:{legend:{display:false}}}
        });
    }

    function updateStatsAndChart(){
        const period = periodSelect.value;
        const {totals} = aggregate(period);
        const today = aggregate('day');
        const weekly = aggregate('week');
        const monthly = aggregate('month');

        todayEl.textContent = secondsToHM(today.tot);
        weeklyEl.textContent = secondsToHM(weekly.tot);
        monthlyEl.textContent = secondsToHM(monthly.tot);
        sessionsCountEl.textContent = sessions.length;

        createChart(subjects.map(s=>s.name), totals);
    }

    periodSelect.onchange = updateStatsAndChart;

    // ===== Pomodoro Timer =====
    let pomoInterval = null;
    let pomoTimeLeft = 25 * 60; // 25 minutes in seconds
    let pomoRunning = false;
    let pomoMode = 'work'; // work, short, long

    const pomoDisplay = document.getElementById('pomoDisplay');
    const pomoStartBtn = document.getElementById('pomoStart');
    const pomoPauseBtn = document.getElementById('pomoPause');
    const pomoResetBtn = document.getElementById('pomoReset');
    const pomoWorkBtn = document.getElementById('pomoWork');
    const pomoShortBtn = document.getElementById('pomoShort');
    const pomoLongBtn = document.getElementById('pomoLong');
    const pomoSessionsEl = document.getElementById('pomoSessions');

    function formatPomoTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function updatePomoDisplay() {
        pomoDisplay.textContent = formatPomoTime(pomoTimeLeft);
        pomoSessionsEl.textContent = pomodoro.sessions;
    }

    function setPomoMode(mode) {
        pomoMode = mode;
        // Update active button
        pomoWorkBtn.classList.remove('active');
        pomoShortBtn.classList.remove('active');
        pomoLongBtn.classList.remove('active');
        
        if (mode === 'work') {
            pomoTimeLeft = 25 * 60;
            pomoWorkBtn.classList.add('active');
        } else if (mode === 'short') {
            pomoTimeLeft = 5 * 60;
            pomoShortBtn.classList.add('active');
        } else if (mode === 'long') {
            pomoTimeLeft = 15 * 60;
            pomoLongBtn.classList.add('active');
        }
        
        updatePomoDisplay();
    }

    function startPomo() {
        if (pomoRunning) return;
        pomoRunning = true;
        pomoStartBtn.disabled = true;
        pomoPauseBtn.disabled = false;
        
        pomoInterval = setInterval(() => {
            pomoTimeLeft--;
            updatePomoDisplay();
            
            if (pomoTimeLeft <= 0) {
                clearInterval(pomoInterval);
                pomoRunning = false;
                pomoStartBtn.disabled = false;
                pomoPauseBtn.disabled = true;
                
                if (pomoMode === 'work') {
                    pomodoro.sessions++;
                    savePomodoro(pomodoro);
                    updatePomoDisplay();
                    
                    // After work session, switch to short break
                    setPomoMode('short');
                    startPomo();
                } else {
                    // After break session, switch back to work
                    setPomoMode('work');
                }
            }
        }, 1000);
    }

    function pausePomo() {
        if (!pomoRunning) return;
        pomoRunning = false;
        clearInterval(pomoInterval);
        pomoStartBtn.disabled = false;
        pomoPauseBtn.disabled = true;
    }

    function resetPomo() {
        pausePomo();
        setPomoMode(pomoMode);
    }

    // Set up event listeners for pomodoro
    pomoStartBtn.addEventListener('click', startPomo);
    pomoPauseBtn.addEventListener('click', pausePomo);
    pomoResetBtn.addEventListener('click', resetPomo);
    pomoWorkBtn.addEventListener('click', () => setPomoMode('work'));
    pomoShortBtn.addEventListener('click', () => setPomoMode('short'));
    pomoLongBtn.addEventListener('click', () => setPomoMode('long'));

    // Initialize pomodoro display
    updatePomoDisplay();

    // --- Init ---
    initTheme();
    renderSubjects(); 
    updateStatsAndChart();
    document.getElementById('sessionsCount').textContent = sessions.length;

    // initial button states
    pauseBtn.disabled=true; saveBtn.disabled=true;

    // data migration guard (if old invalid saved state)
    if(!Array.isArray(subjects) || subjects.length!==DEFAULT_SUBJECTS.length){ subjects = DEFAULT_SUBJECTS.map(name=>({name,chapters:0,completed:0})); saveSubjects(subjects); }
</script>
</body>
</html>
